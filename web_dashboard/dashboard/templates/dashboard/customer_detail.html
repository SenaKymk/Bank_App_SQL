{% extends "dashboard/base.html" %}

{% block title %}Customer #{{ profile.cust_id }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'customer_list' %}" class="text-decoration-none text-muted">Customers</a></li>
<li class="breadcrumb-item active">#{{ profile.cust_id }}</li>
{% endblock %}

{% block page_title %}Customer Profile{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <a href="{% url 'customer_edit' profile.cust_id %}" class="btn btn-outline-primary shadow-sm rounded-3">
        <i class="bi bi-pencil me-1"></i> Edit
    </a>
    <a href="{% url 'customer_predict' profile.cust_id %}" class="btn btn-success shadow-sm rounded-3">
        <i class="bi bi-magic me-1"></i> Run Prediction
    </a>
    <button class="btn btn-outline-danger shadow-sm rounded-3" data-bs-toggle="modal" data-bs-target="#deleteModal">
        <i class="bi bi-trash me-1"></i> Delete
    </button>
</div>
{% endblock %}

{% block content %}

<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Confirm Deletion</h5>
                <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body py-4">
                <div class="text-center mb-3 text-danger">
                    <i class="bi bi-exclamation-octagon fs-1"></i>
                </div>
                <p class="text-center m-0 text-muted">Are you sure you want to delete <strong>Customer #{{ profile.cust_id }}</strong>?</p>
                <p class="text-center fw-bold text-danger mt-1 small text-uppercase">This action is permanent and cannot be undone.</p>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{% url 'customer_delete' profile.cust_id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger rounded-pill px-4">Yes, Delete Permanently</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm mb-4 text-center p-4">
            <div class="card-body">
                <div class="avatar-lg mx-auto mb-3 d-flex align-items-center justify-content-center rounded-circle text-white shadow"
                     style="width:100px; height:100px; font-size:2rem; font-weight:bold; background: linear-gradient(135deg, #2563eb, #7c3aed);">
                    {{ profile.cust_id|stringformat:"s"|slice:"-2:" }}
                </div>
                <h3 class="fw-bold mb-1">ID: #{{ profile.cust_id }}</h3>
                <p class="text-muted small mb-3"><i class="bi bi-geo-alt-fill me-1"></i> {{ profile.province }}, Turkey</p>
                
                <div class="d-flex justify-content-center gap-2 mb-0">
                    <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill">
                        <i class="bi bi-gender-ambiguous me-1"></i> {{ profile.gender }}
                    </span>
                    <span class="badge bg-info bg-opacity-10 text-info px-3 py-2 rounded-pill">
                        <i class="bi bi-calendar-event me-1"></i> {{ profile.age }} yrs
                    </span>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm p-3">
            <h6 class="fw-bold mb-3 px-2">Detailed Information</h6>
            <table class="table table-borderless align-middle mb-0">
                <tr class="border-bottom border-light">
                    <td class="text-muted small py-3">Work Sector</td>
                    <td class="text-end fw-semibold py-3">{{ profile.work_sector }}</td>
                </tr>
                <tr class="border-bottom border-light">
                    <td class="text-muted small py-3">Tenure</td>
                    <td class="text-end fw-semibold py-3">{{ profile.tenure }} Months</td>
                </tr>
                <tr>
                    <td class="text-muted small py-3">Onboarding Date</td>
                    <td class="text-end fw-semibold py-3">{{ profile.created_at|date:"d M Y" }}</td>
                </tr>
            </table>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card border-0 shadow-sm mb-4 overflow-hidden">
            <div class="card-body p-0">
                <div class="d-flex flex-column flex-md-row">
                    <div class="p-4 flex-grow-1 border-end border-light">
                        <h5 class="fw-bold mb-4">Predictive Risk Analysis</h5>
                        
                        <div class="mb-2 d-flex justify-content-between">
                            <span class="text-muted small fw-bold">Churn Risk Status</span>
                            <span class="badge rounded-pill {% if churn.risk == 'High' %}bg-danger{% elif churn.risk == 'Medium' %}bg-warning text-dark{% else %}bg-success{% endif %}">
                                {{ churn.risk }} RISK
                            </span>
                        </div>

                        <div class="progress rounded-pill mb-3" style="height:24px; font-size: 0.8rem; font-weight: bold;">
                            <div class="progress-bar shadow-sm
                                {% if churn.risk == 'High' %}bg-danger
                                {% elif churn.risk == 'Medium' %}bg-warning text-dark
                                {% else %}bg-success{% endif %}"
                                role="progressbar" 
                                style="width: {{ churn.score }}%;" 
                                aria-valuenow="{{ churn.score }}" 
                                aria-valuemin="0" 
                                aria-valuemax="100">
                                {{ churn.score }}%
                            </div>
                        </div>

                        <p class="text-muted small m-0">
                            Our ML model predicts a <strong>{{ churn.probability|floatformat:2 }}</strong> raw probability score based on recent customer behavior and sector trends.
                        </p>
                    </div>
                    
                    <div class="p-4 bg-light d-flex flex-column align-items-center justify-content-center text-center" style="min-width: 200px;">
                        <div class="text-muted small fw-bold text-uppercase mb-2">Health Score</div>
                        <div class="h1 fw-bold {% if churn.risk == 'High' %}text-danger{% elif churn.risk == 'Medium' %}text-warning{% else %}text-success{% endif %} m-0">
                            {{ churn.health_score }}
                        </div>
                        <div class="text-muted small mt-1">out of 100</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h6 class="fw-bold mb-0">Action Suggestions</h6>
            </div>
            <div class="card-body">
                {% if churn.risk == "High" %}
                <div class="d-flex align-items-start gap-3 p-3 rounded-4 bg-danger bg-opacity-10 mb-3 border border-danger border-opacity-10">
                    <i class="bi bi-exclamation-triangle-fill text-danger fs-4"></i>
                    <div>
                        <h6 class="fw-bold text-danger mb-1">Immediate Action Required</h6>
                        <p class="text-danger small mb-0">Customer shows high signs of churn. Suggest offering a sector-specific discount or personal follow-up call.</p>
                    </div>
                </div>
                {% elif churn.risk == "Medium" %}
                <div class="d-flex align-items-start gap-3 p-3 rounded-4 bg-warning bg-opacity-10 mb-3 border border-warning border-opacity-10">
                    <i class="bi bi-eye-fill text-warning fs-4"></i>
                    <div>
                        <h6 class="fw-bold text-warning mb-1">Monitoring Phase</h6>
                        <p class="text-warning small mb-0">Normal fluctuation detected. Monitor activity over the next 15 days for any further decline.</p>
                    </div>
                </div>
                {% else %}
                <div class="d-flex align-items-start gap-3 p-3 rounded-4 bg-success bg-opacity-10 mb-3 border border-success border-opacity-10">
                    <i class="bi bi-check-circle-fill text-success fs-4"></i>
                    <div>
                        <h6 class="fw-bold text-success mb-1">Account Healthy</h6>
                        <p class="text-success small mb-0">Customer engagement is optimal. No action needed at this time.</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}